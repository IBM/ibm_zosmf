# Copyright (c) IBM Corporation 2021 

# This sample playbook demonstrates using roles `zmf_cpm_provision_software_service`, 
# 'zmf_cpm_manage_software_instance' and 'zmf_remove_software_instance' to provision
# a sample service instance, deprovision the instance and remove the deprovisioned instance.
# Example:
# ansible-playbook -i hosts cpm_complete_CICDtest1.yml

- name: Test all roles provided by cpm
  hosts: cpm1
  collections:
    - ibm.ibm_zosmf
  gather_facts: no
  
  tasks:
    - include_role:
        name: zmf_cpm_provision_software_service
      vars:
        cpm_template_name: 'AnsibleFVT'  # The value for property cpm_template_name which identifies the template (software service) user wants to provision with Cloud Provisioning & Management
        domain_name: 'default' # The value for property domain_name which identifies CP&M domain in which specified template is defined

    - name: Save instance info file path
      set_fact:
        instance_file_path: "{{ instance_info_json_path }}"

- hosts: cpm1 
  collections:
    - ibm.ibm_zosmf
  gather_facts: no
  # vars:
  #   - name: instance_file_path        
  tasks:
    - include_role:
        name: zmf_cpm_manage_software_instance
      vars:
        instance_action_name: "deprovision"
        instance_info_json_path: "{{ instance_file_path }}"
                
- hosts: cpm1
  collections:
    - ibm.ibm_zosmf
  gather_facts: no
  # vars:
  #   - name: instance_file_path   
  tasks:
    - include_role:
        name: zmf_cpm_remove_software_instance
      vars:
        instance_info_json_path: "{{ instance_file_path }}"

- hosts: cpm1
  collections:
    - ibm.ibm_zosmf
  gather_facts: no
  # vars:
  #   - name: instance_file_path   
  vars:
    - name: template_info_json_path #will store template json information globally thru the playbook
  
  tasks:
    - include_role:
        name: zmf_cpm_list_software_templates

    - name: Set templates as fact
      set_fact:
        templates: null

    - name: Gather name of published templates and domains
      vars:
           template_info_json: "{{lookup('file', template_info_json_path)}}" # Path of the templates json file

      set_fact:
           templates: "{{item.name}}:{{item['domain-name']}}, {{templates}}"

      loop: "{{ template_info_json['psc-list'] }}"

    - name: Display published templates
      debug:
            msg: "Published Template:Domain are : {{templates}}"

    - name: Clean instance record file
      file:
        state: absent
        path: "{{ template_info_json_path }}"
      delegate_to: localhost
      