# Copyright (c) IBM Corporation 2025
# This playbook demonstrates using roles:
# 'zmf_swupdate_start', 'zmf_swupdate_retrieve',
# and 'zmf_swupdate_copy' to complete the software management
# software update Start, Retrieve, and Copy REST APIs.

#######################################################################################
# THIS PLAYBOOK IS INTENDED TO START A SOFTWARE UPDATE PROCESS, RESOLVE ALL OF THE    #
# SYSTEM HOLDS, AND COMPLETE THE PROCESS WITHOUT SUSPENDING AT ANY STEP.              #
#######################################################################################

#######################################################################################
# PLAY #1: Start a Software Update on a Software Instance.                            #
#######################################################################################
- name: Start a Software Update on a Software Instance
  hosts: swmgmt
  gather_facts: false
  tasks:
    # Resolve all SYSTEM holds by default.
    - name: Setting resolve-holds JSON
      ansible.builtin.set_fact:
        resolve_holds: '[{"type":"SYSTEM"}]'

    # Do not suspend at any step.
    - name: Setting suspend-steps JSON
      ansible.builtin.set_fact:
        suspend_steps: '[]'
    
    - name: Start Software Update
      ansible.builtin.include_role:
        name: ibm.ibm_zosmf.zmf_swupdate_start

#######################################################################################
# PLAY #2: Retrieve the Status of the Software Update.                                #
#######################################################################################
- name: Retrieve the Status of the Software Update
  hosts: swmgmt
  gather_facts: false
  tasks:
    - name: Retrieve Software Update Status
      ansible.builtin.include_role:
        name: ibm.ibm_zosmf.zmf_swupdate_retrieve

#######################################################################################
# PLAY #3: Copy the Software Update output to a directory.                            #
#######################################################################################
- name: Copy the output from the Software Update
  hosts: swmgmt
  gather_facts: false
  tasks:
    - name: Copy Software Update
      ansible.builtin.include_role:
        name: ibm.ibm_zosmf.zmf_swupdate_copy
      when: >
        (swupdate_retrieve_response.json['update-processes'][0]['status'] is defined) and
        ((swupdate_retrieve_response.json['update-processes'][0]['status'] == 'COMPLETED') or
        (swupdate_retrieve_response.json['update-processes'][0]['status'] == 'CANCELED') or
        (swupdate_retrieve_response.json['update-processes'][0]['status'] == 'CANCELED WITH ERROR'))
