# Copyright (c) IBM Corporation 2025
# This playbook demonstrates using roles:
# 'zmf_swupdate_retrieve' and 'zmf_swmgmt_holds_for_reason' to
# gather the HOLDDATA TEXT for HOLDs by querying the global
# zone CSI data set associated with the software instance
# who's software update process identified the HOLDs.

#####################################################################################
# PLAY #1: Retrieve the Software Update for a Software Instance.                    #
#####################################################################################
- name: Retrieve the Software Update for a Software Instance
  hosts: swmgmt
  gather_facts: false
  collections:
    - ibm.ibm_zosmf
  tasks:
    - name: Saving specified output file
      ansible.builtin.set_fact:
        holds_for_reason_file_specified: "{{ holds_for_reason_file }}"
    - name: Retrieve the Software Update
      include_role:
        name: zmf_swupdate_retrieve

#######################################################################################
# PLAY #2: Query the global zone CSI data set on the specified HOLD REASON.           #
#######################################################################################
- name: Determine which CSI and HOLDs to query the HOLDDATA text for
  hosts: swmgmt
  gather_facts: false
  collections:
    - ibm.ibm_zosmf
  tasks:
    - name: Create CSI Query request using the specified HOLD REASON
      include_role:
        name: zmf_swmgmt_holds_for_reason

##########################################################################################
# PLAY #3: Query the global zone CSI data set on the HOLD REASON specified in this play. #
##########################################################################################
- name: Determine which CSI and HOLDs to query the HOLDDATA text for DOC HOLDs
  hosts: swmgmt
  gather_facts: false
  collections:
    - ibm.ibm_zosmf
  tasks:
    # Get HOLDDATA text for HOLDs with the DOC REASON.
    - name: Setting resolve-holds JSON
      ansible.builtin.set_fact:
        hold_reason: 'DOC'
        holds_for_reason_file: "{{ holds_for_reason_file_specified }}"
    - name: "Create CSI Query request using the {{ hold_reason }} HOLD REASON"
      include_role:
        name: zmf_swmgmt_holds_for_reason

##########################################################################################
# PLAY #4: Query the global zone CSI data set on the HOLD REASON specified in this play. #
##########################################################################################
- name: Determine which CSI and HOLDs to query the HOLDDATA text for ACTION HOLDs
  hosts: swmgmt
  gather_facts: false
  collections:
    - ibm.ibm_zosmf
  tasks:
    # Get HOLDDATA text for HOLDs with the ACTION REASON.
    - name: Setting resolve-holds JSON
      ansible.builtin.set_fact:
        hold_reason: 'ACTION'
        holds_for_reason_file: "{{ holds_for_reason_file_specified }}"
    - name: "Create CSI Query request using the {{ hold_reason }} HOLD REASON"
      include_role:
        name: zmf_swmgmt_holds_for_reason

##########################################################################################
# PLAY #5: Query the global zone CSI data set on the HOLD REASON specified in this play. #
##########################################################################################
- name: Determine which CSI and HOLDs to query the HOLDDATA text for RESTART HOLDs
  hosts: swmgmt
  gather_facts: false
  collections:
    - ibm.ibm_zosmf
  tasks:
    # Get HOLDDATA text for HOLDs with the RESTART REASON.
    - name: Setting resolve-holds JSON
      ansible.builtin.set_fact:
        hold_reason: 'RESTART'
        holds_for_reason_file: "{{ holds_for_reason_file_specified }}"
    - name: "Create CSI Query request using the {{ hold_reason }} HOLD REASON"
      include_role:
        name: zmf_swmgmt_holds_for_reason
