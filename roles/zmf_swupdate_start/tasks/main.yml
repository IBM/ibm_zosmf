# Copyright (c) IBM Corporation 2025
# Apache License, Version 2.0 (see https://opensource.org/licenses/Apache-2.0)

---
# Tasks file for zmf_swupdate_start play.

# Do not attempt to execute the play without a software instance or UUID specified.
- name: A software instance and system nickname or a UUID must be provided to the role
  ansible.builtin.fail:
    msg: "Specify a software instance and system nickname or a UUID and retry the role."
  when: >
    (software_instance_uuid is not defined or software_instance_uuid == '') and (software_instance_name is not defined or software_instance_name == ''
    or system_nickname is not defined or system_nickname == '')

# Do not attempt to execute the play without a targetzone.
- name: A target zone must be provided to the role
  ansible.builtin.fail:
    msg: "Specify a target zone and retry the role."
  when: >
    target_zone is not defined or target_zone == ''

# Do not attempt to execute the play without a list of updates, sourceids, or fixcats.
- name: A list of updates, sourceids, or fixcats must be provided to the role
  ansible.builtin.fail:
    msg: "Specify a list of updates, sourceids, or fixcats and retry the role."
  when: (updates is not defined) and (sourceids is not defined) and (fixcats is not defined)

# Create a variable for the start software update response content.
- name: Initialize the container for the start software update response content
  ansible.builtin.set_fact:
    swupdate_start_response: ""

# Set comma variable to empty string to use for first variable added to request content.
- name: "Create comma variable"
  ansible.builtin.set_fact:
    comma: ''

# Add the opening curly brace around the request content JSON.
- name: "Adding opening curly brace for the JSON request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{'

# Add targetzone to the JSON request body if specified.
- name: "Adding targetzone in the request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{{ swupdate_start_request_body }}{{ comma }}"targetzone": "{{ target_zone }}"'
    comma: ','
  when: target_zone is defined

# Add updates to the JSON request body if specified.
- name: "Adding updates in the request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{{ swupdate_start_request_body }}{{ comma }}"updates": {{ updates }}'
    comma: ','
  when: updates is defined

# Add sourceids to the JSON request body if specified.
- name: "Adding sourceids in the request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{{ swupdate_start_request_body }}{{ comma }}"sourceids": {{ sourceids }}'
    comma: ','
  when: sourceids is defined

# Add fixcats to the JSON request body if specified.
- name: "Adding fixcats in the request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{{ swupdate_start_request_body }}{{ comma }}"fixcats": {{ fixcats }}'
    comma: ','
  when: fixcats is defined

# Add suspend steps to the JSON request body if specified.
- name: "Adding suspend steps in the request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{{ swupdate_start_request_body }}{{ comma }}"suspend-steps": {{ suspend_steps }}'
    comma: ','
  when: suspend_steps is defined

# Add exclude updates to the JSON request body if specified.
- name: "Adding exclude updates in the request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{{ swupdate_start_request_body }}{{ comma }}"exclude-updates": {{ exclude_updates }}'
    comma: ','
  when: exclude_updates is defined

# Add resolove holds to the JSON request body if specified.
- name: "Adding resolve holds in the request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{{ swupdate_start_request_body }}{{ comma }}"resolve-holds": {{ resolve_holds }}'
    comma: ','
  when: resolve_holds is defined

# Add smpeuserid to the JSON request body if specified.
- name: "Adding SMP/E userid in the request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{{ swupdate_start_request_body }}{{ comma }}"smpe-userid": "{{ smpe_userid }}"'
    comma: ','
  when: smpe_userid is defined

# Add notes to the JSON request body if specified.
- name: "Adding notes in the request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{{ swupdate_start_request_body }}{{ comma }}"notes": "{{ notes }}"'
    comma: ','
  when: notes is defined

# Add zosmfuid to the JSON request body if specified.
- name: "Adding zosmfuid in the request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{{ swupdate_start_request_body }}{{ comma }}"zosmfuid": "{{ remote_zmf_user }}"'
    comma: ','
  when: remote_zmf_user is defined

# Add zosmfpw to the JSON request body if specified.
- name: "Adding zosmfpw in the request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{{ swupdate_start_request_body }}{{ comma }}"zosmfpw": "{{ remote_zmf_password }}"'
    comma: ','
  when: remote_zmf_password is defined

# Add proxyuid to the JSON request body if specified.
- name: "Adding proxyuid in the request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{{ swupdate_start_request_body }}{{ comma }}"proxyuid": "{{ proxy_zmf_user }}"'
    comma: ','
  when: proxy_zmf_user is defined

# Add proxypw to the JSON request body if specified.
- name: "Adding proxypw in the request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{{ swupdate_start_request_body }}{{ comma }}"proxypw": "{{ proxy_zmf_password }}"'
  when: proxy_zmf_password is defined

# Add the ending curly brace around the request content JSON.
- name: "Adding ending curly brace for the JSON request content body"
  ansible.builtin.set_fact:
    swupdate_start_request_body: '{{ swupdate_start_request_body }}}'

# Ensure there is a colon in the host. Add the z/OSMF server port if specified.
- name: "Set the zmf_port if specified"
  ansible.builtin.set_fact:
    zmf_socket: '{{ zmf_host }}:{{ zmf_port }}'
  when: zmf_port is defined and ':' not in zmf_host

##########################################################################################
# URI MODULE #1: Start a software update for a software instance.                        #
##########################################################################################

# Start a software update operation.
- name: "Start Software Update by Software Instance UUID"
  when: software_instance_uuid is defined
  block:
    # Create a variable for the start software update response content.
    - name: Initialize the container for the start software update by software instance UUID response content
      ansible.builtin.set_fact:
        swupdate_start_uuid_response: ""

    - name: "Start a software update for software instance with UUID <{{ software_instance_uuid }}>"
      ansible.builtin.uri:
        url: "https://{{ zmf_socket }}/zosmf/swmgmt/swi/{{ software_instance_uuid }}/swupdate"
        return_content: true
        user: "{{ zmf_user | trim }}"
        password: "{{ zmf_password | trim }}"
        force_basic_auth: true
        headers:
          Host: "{{ zmf_socket }}"
          Origin: "https://{{ zmf_socket }}"
        method: POST
        status_code: 202, 400, 403, 404, 409, 500, 503
        validate_certs: false
        body_format: json
        body: "{{ swupdate_start_request_body }}"
      delegate_to: localhost
      register: swupdate_start_uuid_response

    - name: "Save start software update by software instance UUID response"
      ansible.builtin.set_fact:
        swupdate_start_response: "{{ swupdate_start_uuid_response }}"

# Start a software update operation.
- name: "Start Software Update by Software Instance Name and System"
  when: software_instance_uuid is not defined and software_instance_name is defined
  block:
    # Create a variable for the start software update response content.
    - name: Initialize the container for the start software update by software instance name and system response content
      ansible.builtin.set_fact:
        swupdate_start_swi_response: ""

    - name: "Start a software update for software instance <{{ software_instance_name }}>"
      ansible.builtin.uri:
        url: "https://{{ zmf_socket }}/zosmf/swmgmt/swi/{{ system_nickname }}/{{ software_instance_name }}/swupdate"
        return_content: true
        user: "{{ zmf_user | trim }}"
        password: "{{ zmf_password | trim }}"
        force_basic_auth: true
        headers:
          Host: "{{ zmf_socket }}"
          Origin: "https://{{ zmf_socket }}"
        method: POST
        status_code: 202, 400, 403, 404, 409, 500, 503
        validate_certs: false
        body_format: json
        body: "{{ swupdate_start_request_body }}"
      delegate_to: localhost
      register: swupdate_start_swi_response

    - name: "Save start software update by software instance name and system response"
      ansible.builtin.set_fact:
        swupdate_start_response: "{{ swupdate_start_swi_response }}"

# Create a variable for the software update process ID.
- name: Set the software update process ID
  ansible.builtin.set_fact:
    swupdate_process_id: "{{ swupdate_start_response.json['processid'] }}"
  when: swupdate_start_response.status == 202

# Issue a failure message when user does not have the APAR with the SWU APIs installed on their system.
- name: Display Start Software Update REST API failure information
  ansible.builtin.fail:
    msg: "There was an error encountered during Start Software Update REST API execution. It's possible the host
      system is missing required APAR PH62240 which contains the software update REST APIs. Otherwise the
      specified software instance or software update process was not found. These are the failure
      details: {{ swupdate_start_response.json }}"
  when: swupdate_start_response.status == 404 and swupdate_start_response.json is defined

# Issue a failure message when user does not have the APAR with the SWU APIs installed on their system.
- name: Display Start Software Update REST API failure information
  ansible.builtin.fail:
    msg: "There was an error encountered during Start Software Update REST API execution. It's possible the host
      system is missing required APAR PH62240 which contains the software update REST APIs. Otherwise the
      specified software instance or software update process was not found. These are the failure
      details: {{ swupdate_start_response }}"
  when: swupdate_start_response.status == 404

# Issue a failure message when user does not have the appropriate authority.
- name: The user does not have the appropriate authority to complete this request
  ansible.builtin.fail:
    msg: "Start Software Update failure details: {{ swupdate_start_response.json }} "
  when: swupdate_start_response.status == 403 and swupdate_start_response.json is defined

# Issue a failure message and stop the playbook.
- name: Display the start software update action failure information
  ansible.builtin.fail:
    msg: "Start Software Update failure details: {{ swupdate_start_response.json }} "
  when: swupdate_start_response.status != 202 and swupdate_start_response.json is defined

# Issue a failure message and stop the playbook.
- name: Display the start software update action failure information
  ansible.builtin.fail:
    msg: "Start Software Update failure details: {{ swupdate_start_response }} "
  when: swupdate_start_response.status != 202
