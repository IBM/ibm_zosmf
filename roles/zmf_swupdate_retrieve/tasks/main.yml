# Copyright (c) IBM Corporation 2025
# Apache License, Version 2.0 (see https://opensource.org/licenses/Apache-2.0)

---
# Tasks file for zmf_swupdate_retrieve play.

# Do not attempt to execute the play without a software instance/system nickname, UUID, or process ID specified.
- name: A software instance and system nickname, a UUID, or a software update process ID must be provided to the role
  ansible.builtin.fail:
    msg: "Specify a software instance and system nickname, a UUID, or a software update process ID and retry the role."
  when: >
    (software_instance_uuid is not defined or software_instance_uuid == '') and (software_instance_name is not defined or software_instance_name == ''
    or system_nickname is not defined or system_nickname == '') and (swupdate_process_id is not defined or swupdate_process_id == '')

# Create a variable for the retrieve software update response content.
- name: Initialize the container for the retrieve software update status response content
  ansible.builtin.set_fact:
    swupdate_retrieve_response: ""

# Ensure there is a colon in the host. Add the z/OSMF server port if specified.
- name: "Set the zmf_port if specified"
  ansible.builtin.set_fact:
    zmf_host: '{{ zmf_host }}:{{ zmf_port }}'
  when: zmf_port is defined and ':' not in zmf_host

###################################################################
# URI MODULE #1: Check the status of the software update process. #
###################################################################

# Wait for the software update process to finish and return a response.
- name: "Retrieve Software Update Status by Process ID"
  when: swupdate_process_id is defined
  block:
    # Create a variable for the retrieve software update response content when a process ID is specified.
    - name: Initialize the container for the retrieve software update status by process ID response content
      ansible.builtin.set_fact:
        swupdate_retrieve_processid_response: ""

    - name: "Check the status of the software update operation every {{ async_thread_check_delay }}
        second(s) until it is finished or maximum {{ async_thread_check_times }} poll(s) reached"
      ansible.builtin.uri:
        url: "https://{{ zmf_host }}/zosmf/swmgmt/swupdate/{{ swupdate_process_id }}"
        method: GET
        user: "{{ zmf_user | trim }}"
        password: "{{ zmf_password | trim }}"
        force_basic_auth: true
        headers:
          Host: "{{ zmf_host }}"
          Origin: "https://{{ zmf_host }}"
        status_code: 200, 404
        validate_certs: false
        return_content: true
      register: swupdate_retrieve_processid_response
      delegate_to: localhost
      # This task's URL will be called repeatedly either until the "until" condition is met (request failed or
      # request completed) or the request still isn't finished after the specified "complete_check_times" attempts.
      until: >
        (swupdate_retrieve_processid_response is failed) or
        ((swupdate_retrieve_processid_response.json['update-processes'][0]['status'] is defined) and
        (swupdate_retrieve_processid_response.json['update-processes'][0]['status'] != 'RUNNING'))
      retries: "{{ async_thread_check_times }}"
      delay: "{{ async_thread_check_delay }}"

    - name: "Save retrieve software update status by process ID response"
      ansible.builtin.set_fact:
        swupdate_retrieve_response: "{{ swupdate_retrieve_processid_response }}"

# Wait for the software update process to finish and return a response.
- name: "Retrieve Software Update Status by Software Instance UUID"
  when: swupdate_process_id is not defined and software_instance_uuid is defined
  block:
    # Create a variable for the retrieve software update response content when a software instance UUID is specified.
    - name: Initialize the container for the retrieve software update status by software instance UUID response content
      ansible.builtin.set_fact:
        swupdate_retrieve_uuid_response: ""

    - name: "Check the status of the software update operation every {{ async_thread_check_delay }}
        second(s) until it is finished or maximum {{ async_thread_check_times }} poll(s) reached"
      ansible.builtin.uri:
        url: "https://{{ zmf_host }}/zosmf/swmgmt/swi/{{ software_instance_uuid }}/swupdate"
        method: GET
        user: "{{ zmf_user | trim }}"
        password: "{{ zmf_password | trim }}"
        force_basic_auth: true
        headers:
          Host: "{{ zmf_host }}"
          Origin: "https://{{ zmf_host }}"
        status_code: 200, 404
        validate_certs: false
        return_content: true
      register: swupdate_retrieve_uuid_response
      delegate_to: localhost
      # This task's URL will be called repeatedly either until the "until" condition is met (request failed or
      # request completed) or the request still isn't finished after the specified "complete_check_times" attempts.
      until: >
        (swupdate_retrieve_uuid_response is failed) or
        ((swupdate_retrieve_uuid_response.json['update-processes'][0]['status'] is defined) and
        (swupdate_retrieve_uuid_response.json['update-processes'][0]['status'] != 'RUNNING'))
      retries: "{{ async_thread_check_times }}"
      delay: "{{ async_thread_check_delay }}"

    - name: "Save retrieve software update status by software instance UUID response"
      ansible.builtin.set_fact:
        swupdate_retrieve_response: "{{ swupdate_retrieve_uuid_response }}"

# Wait for the software update process to finish and return a response.
- name: "Retrieve Software Update Status by Software Instance Name and System"
  when: swupdate_process_id is not defined and software_instance_uuid is not defined and software_instance_name is defined
  block:
    # Create a variable for the retrieve software update response content when a software instance name is specified.
    - name: Initialize the container for the retrieve software update status by software instance name and system response content
      ansible.builtin.set_fact:
        swupdate_retrieve_swi_response: ""

    - name: "Check the status of the software update operation every {{ async_thread_check_delay }}
        second(s) until it is finished or maximum {{ async_thread_check_times }} poll(s) reached"
      ansible.builtin.uri:
        url: "https://{{ zmf_host }}/zosmf/swmgmt/swi/{{ system_nickname }}/{{ software_instance_name }}/swupdate"
        method: GET
        user: "{{ zmf_user | trim }}"
        password: "{{ zmf_password | trim }}"
        force_basic_auth: true
        headers:
          Host: "{{ zmf_host }}"
          Origin: "https://{{ zmf_host }}"
        status_code: 200, 400, 403, 404, 409, 500, 503
        validate_certs: false
        return_content: true
      register: swupdate_retrieve_swi_response
      delegate_to: localhost
      # This task's URL will be called repeatedly either until the "until" condition is met (request failed or
      # request completed) or the request still isn't finished after the specified "complete_check_times" attempts.
      until: >
        (swupdate_retrieve_swi_response is failed) or
        ((swupdate_retrieve_swi_response.json['update-processes'][0]['status'] is defined) and
        (swupdate_retrieve_swi_response.json['update-processes'][0]['status'] != 'RUNNING'))
      retries: "{{ async_thread_check_times }}"
      delay: "{{ async_thread_check_delay }}"

    - name: "Save retrieve software update status by software instance name and system response"
      ansible.builtin.set_fact:
        swupdate_retrieve_response: "{{ swupdate_retrieve_swi_response }}"

# Save the retrieve software update status response for a completed process in a file.
- name: Write the results for the retrieve software update status to a JSON file
  when: >
        (swupdate_retrieve_response.status == 200) and
        (swupdate_retrieve_response.json['update-processes'][0]['status'] is defined) and
        (swupdate_retrieve_response.json['update-processes'][0]['status'] != 'RUNNING')
  block:
    # Perform the copy of the retrieve software update response to the file.
    - name: "Copy the software update results to JSON file <{{ swupdate_retrieve_response_file }}>"
      ansible.builtin.copy:
        content: '{{ swupdate_retrieve_response.json | default("") | to_nice_json(indent=2) }}'
        dest: '{{ swupdate_retrieve_response_file }}'
        mode: '0644'
      delegate_to: localhost

    # Save the response content into a local variable.
    - name: Create a variable to hold the value of the software update results
      ansible.builtin.set_fact:
        swupdate_retrieve_response_json: "{{ swupdate_retrieve_response.json }}"

    # Show the path to the retrieve software update status REST API results file.
    - name: Display the path to the file containing the results from the software update operation
      ansible.builtin.debug:
        msg: "Output filename= {{ swupdate_retrieve_response_file }}"

# Issue a failure message when user does not have the APAR with the SWU APIs installed on their system.
- name: Display Retrieve Software Update Status REST API failure information
  ansible.builtin.fail:
    msg: "There was an error encountered during Retrieve Software Update Status REST API execution. It's possible the host
      system is missing required APAR PH62240 which contains the software update REST APIs. Otherwise the
      specified software instance was not found. These are the failure
      details: {{ swupdate_retrieve_response.json }}"
  when: swupdate_retrieve_response.status == 404 and swupdate_retrieve_response.json is defined

# Issue a failure message when user does not have the APAR with the SWU APIs installed on their system.
- name: Display Retrieve Software Update Status REST API failure information
  ansible.builtin.fail:
    msg: "There was an error encountered during Retrieve Software Update Status REST API execution. It's possible the host
      system is missing required APAR PH62240 which contains the software update REST APIs. Otherwise the
      specified software instance was not found. These are the failure
      details: {{ swupdate_retrieve_response }}"
  when: swupdate_retrieve_response.status == 404

# Issue a failure message when user does not have the appropriate authority.
- name: The user does not have the appropriate authority to complete this request
  ansible.builtin.fail:
    msg: "Retrieve Software Update Status failure details: {{ swupdate_retrieve_response.json }} "
  when: swupdate_retrieve_response.status == 403 and swupdate_retrieve_response.json is defined

# Issue a failure message and stop the playbook.
- name: Display the retrieve software update status action failure information
  ansible.builtin.fail:
    msg: "Retrieve Software Update Status failure details: {{ swupdate_retrieve_response.json }} "
  when: swupdate_retrieve_response.status != 200 and swupdate_retrieve_response.json is defined

# Issue a failure message and stop the playbook.
- name: Display the retrieve software update status action failure information
  ansible.builtin.fail:
    msg: "Retrieve Software Update Status failure details: {{ swupdate_retrieve_response }} "
  when: swupdate_retrieve_response.status != 200
